# AI Terminal User Guide

Welcome to AI Terminal! This guide documents the features and shortcuts available in the application.

## Features

### 1. Shell Integration & Markers
The terminal detects when commands start and finish (bash and zsh supported).
- **Markers**: When shell integration is active, a visual indicator appears in the gutter (left side) for every command.
  - **Grey**: Command is running.
  - **Green**: Command finished successfully (Exit Code 0).
  - **Red**: Command failed (Non-zero Exit Code).
- **Remote sessions**: By default inside AI Terminal, `ssh` is aliased to `aiterm_ssh` so markers are enabled automatically. To opt out for a single command, run `\ssh <host>` (backslash avoids the alias) or start a new tab and remove the alias. `aiterm_ssh` injects the shell integration on the remote side without leaving a permanent file. For non-interactive `ssh host command`, it falls back to plain `ssh` (single marker on the local command).
- **SSH in scripts**: AI Terminal also installs a small `ssh` shim in `~/.config/aiterminal/bin/ssh` and prepends `~/.config/aiterminal/bin` to `PATH` for shells it launches. This allows scripts that call `ssh` to still benefit from `aiterm_ssh` when running inside AI Terminal.
- **Privilege changes (`su`)**: `su` is **not** overridden by default. `su` implementations vary (util-linux, busybox, BSD), and wrapper-based bootstrapping can silently fail. If you need markers after `su`, the sustainable approach is to install the integration in that target account (see “Remote install” below).
- **Containers**: In AI Terminal, interactive `docker` / `podman` and `apptainer` shells attempt to bootstrap integration so markers keep working inside long container sessions.
- **Remote bootstrap safety**: The SSH helper is sent as a base64 payload; if it fails to decode or validate, the session falls back to a normal login shell without markers.
- **Hide payload (optional)**: Set `AITERM_SSH_HIDE_PAYLOAD=1` to send the helper via SSH `SendEnv` instead of embedding it in the command line. This requires `AcceptEnv AITERM_B64` on the remote SSH server; otherwise markers will be disabled for that session.
- **Debugging hooks**: Set `AITERM_HOOK_DEBUG=1` before launching a shell to print which hook path is used (bash `PROMPT_COMMAND` array vs string, zsh hook install).

#### Remote install (recommended for HPC reliability)
If you frequently SSH into the same accounts, install the integration script on the remote side once. This avoids relying on SSH bootstrapping tricks and is more resilient across long sessions.

- Run: `aiterm_install_remote user@host`
- What it does:
  - Copies `~/.config/aiterminal/bash_init.sh` to `user@host:~/.config/aiterminal/bash_init.sh`
  - Appends a single `source ~/.config/aiterminal/bash_init.sh` line to the remote `~/.bashrc` and `~/.zshrc` (idempotent)

Notes:
- Requires `ssh` and `scp` availability.
- Targets bash/zsh initialization (`~/.bashrc`, `~/.zshrc`). Other shells may require manual setup.

If markers are missing in a particular environment, you can still manually select output text or use the copy tools for the nearest marker.

### 2. Smart Copy
You can easily copy commands and their outputs without manually selecting text.
- **Click a Marker**: Clicking on any command marker opens a "Copy Options" dialog.
  - **Copy Command Only**: Copies just the command text (e.g., `ls -la`).
  - **Copy Output Only**: Copies just the output generated by that command.
  - **Add to AI Context**: Add command/output to the AI Panel context.

### 3. AI Panel
The AI Panel provides context-aware assistance alongside the terminal with powerful automated tool execution.

#### Interface
- **Toggle**: Use the AI Panel button in the top bar or press `Cmd + B` (macOS) / `Ctrl + B` (Windows/Linux).
- **Detach**: Pop the panel into its own window and reattach when needed.
- **Chat Tab**: Send prompts and see responses stream in with markdown formatting.
- **Context Tab**: Staged context items can be previewed, removed, or cleared.

#### AI Capabilities & Tools
The AI assistant has access to 16 powerful tools that execute automatically to help you:

**File Operations**
1. **execute_command** - Run any shell command in your current terminal directory
   - Examples: Check versions, run git commands, install packages, view logs
   - Dangerous commands (rm, sudo, etc.) require approval when enabled in settings

2. **read_file** - Read and analyze file contents
   - Examples: Check package.json, read configuration files, examine logs
   - Supports text files up to 50KB by default

3. **write_file** - Create new files or overwrite existing ones
   - Examples: Create config files, generate scripts, fix code files
   - Overwrites require approval when enabled

4. **append_to_file** - Add content to the end of a file
   - Examples: Add to logs, update lists, append notes
   - Creates file if it doesn't exist

5. **list_directory** - Browse directory contents
   - Shows files and subdirectories
   - Works with absolute paths

6. **tail_file** - Read the last N lines of a file
   - More efficient than reading entire large log files
   - Default: 50 lines, configurable

7. **make_directory** - Create directories (and parents if needed)
   - Examples: Set up project structure, create nested folders

**Search & Discovery**
8. **search_files** - Find files by name pattern or content
   - Glob patterns for filenames (e.g., `*.ts`, `**/*.json`)
   - Content search across files

**Git Operations**
9. **git_status** - Get current branch, staged files, uncommitted changes
   - Helps AI understand your git repository state

10. **get_git_diff** - Show uncommitted changes
    - See what's been modified before committing

**System & Process**
11. **find_process** - Search for running processes by name
    - Examples: Find node processes, check for running servers
    - Useful for debugging "port already in use" errors

12. **check_port** - Check if a network port is in use
    - Shows which process is using the port
    - Common for debugging port conflicts

13. **get_system_info** - Get OS, architecture, and disk space
    - Useful for environment debugging

14. **get_environment_variable** - Check environment variables
    - Examples: PATH, HOME, custom variables

**Utilities**
15. **calculate** - Evaluate mathematical expressions
    - Examples: Unit conversions, sizing calculations
    - Supports arithmetic and math functions

16. **web_search** - Generate search URLs for documentation
    - Suggests Google searches when external info is needed
    - Cannot actually browse but provides helpful links

#### Command Approval System
Dangerous commands are protected by an interactive approval system:

- **Settings**: Enable/disable in Settings → AI → "Require approval before executing commands"
- **Safe by Default**: Enabled by default for security
- **Automatic Detection**: Commands like `rm`, `sudo`, `dd`, `chmod`, `kill`, etc. are flagged
- **Approval UI**: When a dangerous command is detected:
  1. Execution pauses immediately
  2. Approval card appears showing command, reason, and working directory
  3. Click **✓ Run** to execute or **✗ Cancel** to deny
  4. AI receives result or denial and continues accordingly
- **Safe Commands**: Read-only commands (pwd, ls, cat, grep, etc.) run automatically
- **Transparency**: All tool executions are logged in the console for debugging

#### Multi-Step Tool Execution
The AI can automatically chain multiple tools together to accomplish complex tasks:
- **Example**: "What files are in my current directory?"
  1. AI calls `execute_command("pwd")` to get your location
  2. AI calls `list_directory("/your/path")` with the result
  3. AI generates a formatted response with the file list

- **Example**: "Find the main TypeScript file and show me the first 20 lines"
  1. AI searches for `*.ts` files
  2. AI identifies the main file
  3. AI reads and displays the relevant portion

The AI can perform up to 5 sequential tool calls per request, allowing it to solve complex tasks autonomously.

#### Features
- **Streaming Responses**: Text appears in real-time as the AI generates it
- **Markdown Rendering**: Responses include formatted text, links, tables, code blocks, and emphasis
- **Code Block Copy**: Each code block includes a copy button for easy use
- **Automatic Tool Execution**: Tools run automatically with full transparency
- **Command Approval**: Dangerous commands pause for user approval (configurable)
- **Cancel Requests**: Stop AI requests mid-stream with the Cancel button
- **Export Chat**: Download conversation history as markdown file with native save dialog
- **Terminal Context Aware**: AI knows your current terminal directory for accurate file operations
- **Context Management**: Add commands, outputs, files, or selections to provide context for AI queries
- **Tool Execution Status**: See pending approvals with command preview and working directory

#### Adding Context
- **Capture Last N**: Capture the last N completed commands/outputs from your terminal
- **Add File Path**: Capture file contents using a path and size cap (works over SSH)
- **Selection Capture**: Select text in the terminal and use "Add Selection to Context"
- **Marker Context**: Click any command marker and choose "Add to AI Context"

#### Example Prompts
Try these to see the AI's capabilities:

**File Operations**
- "What files are in my current directory?"
- "Read the package.json and tell me what scripts are available"
- "Create a new config.json file with default settings"
- "Add a TODO item to my notes.txt file"
- "Show me the last 100 lines of the error log"
- "Create a new src/components folder"

**Git Operations**
- "What's my current git branch and status?"
- "Show me what changes I haven't committed yet"
- "Check if I have any uncommitted changes"

**System & Debugging**
- "Check if Node.js is installed and what version"
- "Is port 8080 in use? What's using it?"
- "Find all node processes running"
- "What's my system architecture and OS version?"

**Search & Discovery**
- "Find all TypeScript files in src/"
- "Search for TODO comments in this project"
- "Show me what's in the README file"
- "List all Python files in the current directory"

**Code & Scripts**
- "Write a simple hello world script in Python"
- "Fix the syntax error in app.js"
- "Create a .gitignore file for a Node.js project"

**Calculations & Utilities**
- "How many kilobytes is 1048576 bytes?"
- "Calculate 15% of 250"
- "What's the square root of 144?"

### 4. Font Zooming
Adjust the text size to your preference. The terminal window automatically reflows text when zooming.

### 5. Search
Find text within your terminal buffer.
- Press `Cmd + F` to open the search bar.
- Type to highlight matches.
- Press `Enter` for next match, `Shift + Enter` for previous.

### 6. Scrolling & Scrollbar
- Mouse wheel/trackpad scrolling is supported. A visible right-hand scrollbar overlay appears; you can click or drag it to move through the buffer.
- If system scrollbars are hidden (e.g., macOS auto-hide), the overlay ensures you still see position and can drag to scroll.

### 7. Clickable Links
URLs in the terminal are automatically detected.
- **Hover**: The link will be underlined.
- **Click**: Opens the link in your default browser.

### 8. Tabs
Manage multiple terminal sessions in a single window.
- **New Tab**: Press `Cmd + T` to open a new tab.
- **Close Tab**: Press `Cmd + W` or click the `×` icon on the tab.
- **Exit**: Typing `exit` in the shell will close the current tab.
- **Close App**: Closing the last tab will close the application.

## Keyboard Shortcuts

| Action | Shortcut (macOS) | Shortcut (Windows/Linux) |
|--------|------------------|--------------------------|
| **New Tab** | `Cmd` + `T` | `Ctrl` + `T` |
| **Close Tab** | `Cmd` + `W` | `Ctrl` + `W` |
| **Zoom In** | `Cmd` + `+` (or `=`) | `Ctrl` + `+` (or `=`) |
| **Zoom Out** | `Cmd` + `-` | `Ctrl` + `-` |
| **Reset Zoom** | `Cmd` + `0` | `Ctrl` + `0` |
| **Find** | `Cmd` + `F` | `Ctrl` + `F` |
| **Toggle AI Panel** | `Cmd` + `B` | `Ctrl` + `B` |
| **Open Settings** | `Cmd` + `,` | `Ctrl` + `,` |
| **Copy** | `Cmd` + `C` | `Ctrl` + `C` |
| **Paste** | `Cmd` + `V` | `Ctrl` + `V` |

## Configuration
The terminal creates a configuration directory at `~/.config/aiterminal/`.
- **`bash_init.sh`**: This script is automatically generated and sourced to provide the shell integration features.
- **`bin/ssh`**: A small shim used so `ssh` inside scripts can still bootstrap integration (when running inside AI Terminal).

## AI Settings
Open Settings → AI to configure providers and models.
- **Providers**: OpenAI (recommended), Anthropic, Gemini, Ollama
- **Models**: Any model that supports function calling/tool use
  - OpenAI: gpt-4, gpt-4o, gpt-4-turbo, gpt-3.5-turbo
  - Requires tool calling support for automatic command execution
- **API Key**: Required for cloud providers (OpenAI, Anthropic, Gemini)
- **Custom URL**: Override base API endpoints (useful for Ollama or proxies)
- **Test Connection**: Validates credentials and populates model dropdowns
- **Command Approval**: Enable/disable approval requirement for dangerous commands
  - When enabled: Commands like `rm`, `sudo`, `chmod` require user approval
  - When disabled: All commands execute automatically (use with caution)
  - Safe commands (ls, pwd, cat, grep) always run automatically

### Technical Implementation
The AI system is built on:
- **Vercel AI SDK v5** for robust streaming and tool execution
- **Automatic Tool Calling**: 16 tools execute seamlessly to accomplish tasks
- **Multi-Step Execution**: Up to 5 sequential tool calls per request using `stopWhen`
- **Approval System**: Promise-based blocking for dangerous command approval
- **Terminal Integration**: Uses `get_pty_cwd` to determine your actual working directory
- **Type-Safe**: Tool schemas validated with Zod for reliable execution
- **Cancellation**: AbortController-based request cancellation
- **Export**: Native file system integration for saving conversations

## Troubleshooting

### Terminal Markers
- **Markers not showing (local)?** Open a fresh tab so the helper re-sources; bash and zsh are supported.
- **Markers not showing (remote)?** Use `aiterm_ssh <user@host>` (or plain `ssh` is already aliased to it inside AI Terminal). If the remote blocks sourcing, bypass with `\ssh` to avoid the alias.
- **Markers missing after `su`/restricted shells?** Install integration into that account with `aiterm_install_remote` (or manually add `source ~/.config/aiterminal/bash_init.sh` in that account's `~/.bashrc`/`~/.zshrc`). Some environments intentionally scrub environment variables; in those cases, exact command markers may not be available.

### AI Panel
- **Blank AI responses?** Ensure your AI settings are configured with a valid API key and model that supports tool calling.
- **AI not using tools?** Check that you're using a model with function calling support (e.g., gpt-4, gpt-4o, gpt-4-turbo, not base models).
- **Wrong directory for commands?** The AI automatically detects your terminal's working directory. If issues persist, try `cd` to refresh.
- **Tool execution errors?** Check console logs (View → Developer → Developer Tools) for detailed error messages.
- **Connection errors?** Verify your API key and internet connection. Test with the "Test Connection" button in Settings.
- **Command not executing after approval?** Check console for errors. The approval system waits for your decision before proceeding.
- **Dangerous commands running without approval?** Verify "Require approval for commands" is enabled in Settings → AI.
- **Export not working?** Ensure the fs and dialog plugins are properly initialized (check console for errors).
- **Can't cancel request?** The Cancel button appears while sending. If it's unresponsive, check for network issues or refresh the app.

### General
- **Copy not working?** The app uses the system clipboard. Ensure you have granted permission if prompted.
- **Scrollbar missing?** The app renders its own overlay. If you still don't see it, ensure you're in the terminal area and the buffer is longer than the viewport; try scrolling once to reveal it.
- **Performance issues?** Try closing unused tabs or clearing the terminal buffer (`Cmd + K`).
